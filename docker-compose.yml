services:
  new-api:
    build: .
    container_name: new-api
    restart: always
    command: --log-dir /app/logs
    ports:
      - "3000:3000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
      - ./web:/app/web
    environment:
      # 关键修改：指向旧 MySQL 容器（使用容器名和网络内地址）
      - SQL_DSN=root:eZ1rW9jR6mU6uP4b@tcp(newapi_8d5g-mysql-1:3306)/new-api
      # 关键修改：指向旧 Redis 容器（使用容器名和网络内地址）
      - REDIS_CONN_STRING=redis://newapi_8d5g-redis-1:6379
      - TZ=Asia/Shanghai
      - ERROR_LOG_ENABLED=true # 是否启用错误日志记录 (Whether to enable error log recording)
      - BATCH_UPDATE_ENABLED=true  # 是否启用批量更新 (Whether to enable batch update)
      - GENERATE_DEFAULT_TOKEN=true  # 启用用户注册后自动生成默认令牌
      - TASK_PRICE_PATCH=sora-2,sora-2-hd,sora-2-pro,veo3,veo3-pro,veo3.1,veo3.1-pro  # Sora渠道扣费修复：将sora模型添加到价格补丁列表，跳过seconds参数计算
      # 其他环境变量保持不变...
    # 关键修改：加入旧容器所在的 baota_net 网络
    networks:
      - baota_net
    # 移除原有的 depends_on 中对 redis/mysql 的依赖（因为使用外部容器）
    depends_on: []
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

# 原有的 redis、mysql 服务需要注释掉（避免重复创建）
#  redis:
#    ...
#  mysql:
#    ...

# 声明外部网络（指向 baota_net）
networks:
  baota_net:
    external: true  # 表示使用已存在的网络
