# New-API Docker Compose Configuration (复用外部Redis和MySQL)
# 注意：确保现有Redis和MySQL容器与当前服务在同一网络，或可通过IP访问

services:
  new-api:
    build: .
    container_name: new-api
    restart: always
    command: --log-dir /app/logs
    ports:
      - "3000:3000"
    volumes:
      - ./data:/data           # 本地数据持久化
      - ./logs:/app/logs       # 日志目录
      - ./web:/app/web         # 前端资源目录（已打包的web/dist在此处）
    environment:
      # 连接外部现有MySQL（替换为你的实际MySQL连接信息）
      - SQL_DSN=root:eZ1rW9jR6mU6uP4b@tcp(newapi_pm8s-mysql-1:3306)/new-api
      # 连接外部现有Redis（替换为你的实际Redis连接信息）
      - REDIS_CONN_STRING=redis://newapi_pm8s-redis-1:6379/0
      - TZ=Asia/Shanghai
      - ERROR_LOG_ENABLED=true
      - BATCH_UPDATE_ENABLED=true
      - GENERATE_DEFAULT_TOKEN=true
      - TASK_PRICE_PATCH=sora-2,sora-2-hd,sora-2-pro,veo3,veo3-pro,veo3.1,veo3.1-pro
      # 若多机部署，必须设置以下参数
      # - SESSION_SECRET=你的随机字符串
      # - CRYPTO_SECRET=你的加密密钥

    # 无需依赖内部服务，注释或删除原有depends_on
    # depends_on:
    #   - redis
    #   - mysql

    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

# 移除内部Redis和MySQL服务定义（因为要复用外部容器）
# 原redis、postgres、mysql服务块及volumes相关配置全部删除

# volumes:
#   pg_data:
#   mysql_data: